<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arena Survivor Pro</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }
        #ui {
            position: absolute; top: 20px; left: 20px; color: #0f0; 
            background: rgba(0,0,0,0.7); padding: 15px; border: 2px solid #0f0;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #0f0; font-size: 20px; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="ui">
        <div>MODUS: <span id="view-mode">1ST PERSON</span></div>
        <div>VÅPEN: <span id="weapon-status">INGEN (Finn 'Pistol' med T)</span></div>
        <div>HP: <span id="hp">100</span> | FIENDER: <span id="enemies-count">0</span></div>
        <div style="font-size: 10px; margin-top: 10px; color: #888;">
            W/S: Beveg | A/D: Snu | I: Skyte | T: Plukk opp | B: Toggle 3rd Person
        </div>
    </div>
    <div id="crosshair">+</div>
    <canvas id="game"></canvas>

<script>
/**
 * ENGINE CONFIG
 */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 640; canvas.height = 360;

// MAP: 24x24 Stor Arena
const mapSize = 24;
const world = [
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,0,2,2,0,0,0,0,0,2,2,0,0,0,2,2,0,0,0,0,2,2,0,1,
    1,0,2,0,0,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,2,0,1,
    1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,
    1,0,0,0,3,3,3,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,1,
    1,0,0,0,3,0,0,0,0,0,0,0,1,0,0,0,0,0,0,3,0,0,0,1,
    1,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,1,
    1,0,0,0,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0,1,
    1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1,1,1,
    1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1,1,1,
    1,0,0,0,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0,1,
    1,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,1,
    1,0,0,0,3,0,0,0,0,0,0,0,1,0,0,0,0,0,0,3,0,0,0,1,
    1,0,0,0,3,3,3,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,1,
    1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,
    1,0,2,0,0,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,0,2,0,1,
    1,0,2,2,0,0,0,0,0,2,2,0,0,0,2,2,0,0,0,0,2,2,0,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
];

// Spilleren
let player = {
    x: 12, y: 12, dirX: -1, dirY: 0, planeX: 0, planeY: 0.66,
    hp: 100, hasWeapon: false, is3rdPerson: false, shootTimer: 0
};

// Objekter (Våpen og Fiender)
let sprites = [
    { x: 10, y: 10, type: 'weapon', active: true },
    { x: 5, y: 5, type: 'enemy', active: true, hp: 3 },
    { x: 18, y: 18, type: 'enemy', active: true, hp: 3 },
    { x: 5, y: 18, type: 'enemy', active: true, hp: 3 }
];

const keys = {};
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

/**
 * LOGIKK
 */
function update() {
    const moveSpeed = 0.08;
    const rotSpeed = 0.05;

    // Toggle 3rd Person (B)
    if (keys['KeyB']) {
        player.is3rdPerson = !player.is3rdPerson;
        document.getElementById('view-mode').innerText = player.is3rdPerson ? "3RD PERSON" : "1ST PERSON";
        keys['KeyB'] = false; // Hindre spam
    }

    // Bevegelse W/S og Rotasjon A/D
    if (keys['KeyW']) move(moveSpeed);
    if (keys['KeyS']) move(-moveSpeed);
    if (keys['KeyD']) rotate(-rotSpeed);
    if (keys['KeyA']) rotate(rotSpeed);

    // Plukk opp (T)
    if (keys['KeyT']) {
        sprites.forEach(s => {
            if (s.type === 'weapon' && dist(player.x, player.y, s.x, s.y) < 1) {
                s.active = false;
                player.hasWeapon = true;
                document.getElementById('weapon-status').innerText = "PISTOL (KLAR)";
            }
        });
    }

    // Skyt (I)
    if (keys['KeyI'] && player.hasWeapon && player.shootTimer <= 0) {
        player.shootTimer = 20;
        checkHit();
    }
    if (player.shootTimer > 0) player.shootTimer--;

    // Fiende AI (Finders)
    sprites.forEach(s => {
        if (s.type === 'enemy' && s.active) {
            let dx = player.x - s.x;
            let dy = player.y - s.y;
            let d = Math.sqrt(dx*dx + dy*dy);
            if (d < 10 && d > 0.5) {
                s.x += (dx/d) * 0.03;
                s.y += (dy/d) * 0.03;
            }
            if (d < 0.6) player.hp -= 0.2;
        }
    });

    document.getElementById('hp').innerText = Math.ceil(player.hp);
    document.getElementById('enemies-count').innerText = sprites.filter(s => s.type === 'enemy' && s.active).length;
}

function move(speed) {
    if (world[Math.floor(player.x + player.dirX * speed) + Math.floor(player.y) * mapSize] === 0) player.x += player.dirX * speed;
    if (world[Math.floor(player.x) + Math.floor(player.y + player.dirY * speed) * mapSize] === 0) player.y += player.dirY * speed;
}

function rotate(speed) {
    let oldDirX = player.dirX;
    player.dirX = player.dirX * Math.cos(speed) - player.dirY * Math.sin(speed);
    player.dirY = oldDirX * Math.sin(speed) + player.dirY * Math.cos(speed);
    let oldPlaneX = player.planeX;
    player.planeX = player.planeX * Math.cos(speed) - player.planeY * Math.sin(speed);
    player.planeY = oldPlaneX * Math.sin(speed) + player.planeY * Math.cos(speed);
}

function dist(x1, y1, x2, y2) { return Math.sqrt((x2-x1)**2 + (y2-y1)**2); }

function checkHit() {
    sprites.forEach(s => {
        if (s.type === 'enemy' && s.active) {
            // Enkel sjekk om fienden er i sikte (vinkel og avstand)
            let dx = s.x - player.x;
            let dy = s.y - player.y;
            let angle = Math.atan2(dy, dx);
            let playerAngle = Math.atan2(player.dirY, player.dirX);
            let diff = Math.abs(angle - playerAngle);
            if (diff < 0.2 && dist(player.x, player.y, s.x, s.y) < 8) {
                s.hp--;
                if (s.hp <= 0) s.active = false;
            }
        }
    });
}

/**
 * RENDERING (RAYCASTING)
 */
function draw() {
    // Bakgrunn
    ctx.fillStyle = "#111"; ctx.fillRect(0,0,canvas.width, canvas.height/2); // Tak
    ctx.fillStyle = "#333"; ctx.fillRect(0,canvas.height/2,canvas.width, canvas.height/2); // Gulv

    // Raycast variabler
    let camX = player.x, camY = player.y;
    if (player.is3rdPerson) {
        // Flytt kameraet 2 enheter bak spilleren
        camX = player.x - player.dirX * 1.5;
        camY = player.y - player.dirY * 1.5;
    }

    const zBuffer = [];

    // Tegn vegger
    for (let x = 0; x < canvas.width; x++) {
        let cameraX = 2 * x / canvas.width - 1;
        let rayDirX = player.dirX + player.planeX * cameraX;
        let rayDirY = player.dirY + player.planeY * cameraX;

        let mapX = Math.floor(camX);
        let mapY = Math.floor(camY);

        let deltaX = Math.abs(1 / rayDirX);
        let deltaY = Math.abs(1 / rayDirY);
        let stepX, stepY, sideX, sideY, hit=0, side;

        if (rayDirX < 0) { stepX = -1; sideX = (camX - mapX) * deltaX; }
        else { stepX = 1; sideX = (mapX + 1.0 - camX) * deltaX; }
        if (rayDirY < 0) { stepY = -1; sideY = (camY - mapY) * deltaY; }
        else { stepY = 1; sideY = (mapY + 1.0 - camY) * deltaY; }

        while(hit == 0) {
            if (sideX < sideY) { sideX += deltaX; mapX += stepX; side = 0; }
            else { sideY += deltaY; mapY += stepY; side = 1; }
            if (world[mapX + mapY * mapSize] > 0) hit = 1;
        }

        let perpDist = (side == 0) ? (sideX - deltaX) : (sideY - deltaY);
        zBuffer[x] = perpDist;

        let h = Math.floor(canvas.height / perpDist);
        let start = -h/2 + canvas.height/2;
        
        let color = world[mapX + mapY * mapSize] == 1 ? "#555" : "#772";
        if (side == 1) ctx.globalAlpha = 0.7; // Enkel skygge på sider
        ctx.fillStyle = color;
        ctx.fillRect(x, start, 1, h);
        ctx.globalAlpha = 1.0;
    }

    // Tegn Sprites (Fiender og Våpen)
    sprites.sort((a,b) => dist(player.x,player.y,b.x,b.y) - dist(player.x,player.y,a.x,a.y));
    sprites.forEach(s => {
        if (!s.active) return;
        let sx = s.x - camX, sy = s.y - camY;
        let invDet = 1.0 / (player.planeX * player.dirY - player.dirX * player.planeY);
        let transX = invDet * (player.dirY * sx - player.dirX * sy);
        let transY = invDet * (-player.planeY * sx + player.planeX * sy);
        
        if (transY > 0.1) {
            let screenX = Math.floor((canvas.width / 2) * (1 + transX / transY));
            let sH = Math.abs(Math.floor(canvas.height / transY));
            let sW = Math.abs(Math.floor(canvas.height / transY));

            if (zBuffer[screenX] > transY) {
                ctx.fillStyle = s.type === 'weapon' ? "#0af" : "#f00";
                ctx.fillRect(screenX - sW/2, canvas.height/2 - sH/4, sW, sH/2);
            }
        }
    });

    // Tegn Spiller-modell (KUN i 3rd Person)
    if (player.is3rdPerson) {
        ctx.fillStyle = "#0f0";
        ctx.fillRect(canvas.width/2 - 10, canvas.height/2 + 20, 20, 60);
    } else {
        // Våpen i 1. person
        if (player.hasWeapon) {
            ctx.fillStyle = "#222";
            ctx.fillRect(canvas.width - 200, canvas.height - 150 + (player.shootTimer*2), 100, 200);
        }
    }
}



function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
