<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billig Bror: Arena Pro</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }
        
        #hud {
            position: absolute; top: 20px; left: 20px; color: white;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
            border-left: 5px solid #3498db; pointer-events: none;
        }

        #death-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(139, 0, 0, 0.9); color: white;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 999;
        }

        .stat-bar { width: 200px; height: 15px; background: #333; margin-top: 5px; border-radius: 5px; overflow: hidden; }
        #hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.3s; }
    </style>
</head>
<body>

    <div id="hud">
        <div style="font-weight: bold; font-size: 18px; margin-bottom: 5px;">SURVIVOR STATUS</div>
        HP: <span id="hp-text">100</span>
        <div class="stat-bar"><div id="hp-fill"></div></div>
        <div id="weapon-status" style="margin-top: 10px; color: #aaa;">LOKALISER VÅPEN (BLÅ BOKS)</div>
    </div>

    <div id="death-screen">
        <h1 style="font-size: 80px; margin: 0;">TERMINATED</h1>
        <button onclick="location.reload()" style="padding: 15px 40px; font-size: 20px; cursor: pointer; border: none; background: white; font-weight: bold;">TRY AGAIN</button>
    </div>

    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 640; 
canvas.height = 360;

// MAP: 0=luft, 1=murstein, 2=stål, 3=speil/glass
const mapSize = 24;
const map = [
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,0,3,3,0,0,2,2,0,0,0,0,0,0,2,2,0,0,0,0,3,3,0,1,
    1,0,3,3,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,3,3,0,1,
    1,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,1,
    1,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,1,
    1,0,0,0,0,3,3,0,0,0,0,1,1,0,0,0,0,3,3,0,0,0,0,1,
    1,1,1,0,0,3,3,0,0,0,0,1,1,0,0,0,0,3,3,0,0,1,1,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,0,3,3,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,3,3,0,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
];

let player = {
    x: 12, y: 10, dirX: -1, dirY: 0, planeX: 0, planeY: 0.66,
    hp: 100, hasWeapon: false, is3rdPerson: false,
    pitch: 0, recoil: 0, flash: 0, dead: false
};

let sprites = [
    {x: 12, y: 5, type: 'gun', active: true},
    {x: 5, y: 5, type: 'gun', active: true},
    {x: 19, y: 10, type: 'gun', active: true},
    {x: 5, y: 2, type: 'enemy', active: true, hp: 3},
    {x: 18, y: 2, type: 'enemy', active: true, hp: 3}
];

const keys = {};
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

function move(s) {
    if (map[Math.floor(player.x + player.dirX * s) + Math.floor(player.y) * mapSize] === 0) player.x += player.dirX * s;
    if (map[Math.floor(player.x) + Math.floor(player.y + player.dirY * s) * mapSize] === 0) player.y += player.dirY * s;
}

function rotate(s) {
    let oldX = player.dirX;
    player.dirX = player.dirX * Math.cos(s) - player.dirY * Math.sin(s);
    player.dirY = oldX * Math.sin(s) + player.dirY * Math.cos(s);
    let oldPX = player.planeX;
    player.planeX = player.planeX * Math.cos(s) - player.planeY * Math.sin(s);
    player.planeY = oldPX * Math.sin(s) + player.planeY * Math.cos(s);
}

function update() {
    if (player.dead) return;

    if (keys['KeyW']) move(0.08);
    if (keys['KeyS']) move(-0.08);
    if (keys['KeyD']) rotate(-0.05);
    if (keys['KeyA']) rotate(0.05);
    if (keys['ArrowUp']) player.pitch = Math.min(player.pitch + 10, 200);
    if (keys['ArrowDown']) player.pitch = Math.max(player.pitch - 10, -200);
    if (keys['KeyB']) { player.is3rdPerson = !player.is3rdPerson; keys['KeyB'] = false; }

    // Plukk opp våpen (T)
    if (keys['KeyT']) {
        sprites.forEach(s => {
            if (s.type === 'gun' && s.active && Math.hypot(s.x - player.x, s.y - player.y) < 1) {
                s.active = false;
                player.hasWeapon = true;
                document.getElementById('weapon-status').innerText = "VÅPEN: PISTOL MOD 1";
                document.getElementById('weapon-status').style.color = "#3498db";
            }
        });
    }

    // Skyte (I)
    if (keys['KeyI'] && player.hasWeapon && player.recoil === 0) {
        player.recoil = 20;
        player.flash = 5;
        // Hit detection
        sprites.forEach(s => {
            if (s.type === 'enemy' && s.active) {
                let angle = Math.atan2(s.y - player.y, s.x - player.x);
                let pAngle = Math.atan2(player.dirY, player.dirX);
                if (Math.abs(angle - pAngle) < 0.1 && Math.hypot(s.x - player.x, s.y - player.y) < 15) {
                    s.hp--; if (s.hp <= 0) s.active = false;
                }
            }
        });
    }

    if (player.recoil > 0) player.recoil -= 2;
    if (player.flash > 0) player.flash--;

    // Fiende AI
    sprites.forEach(s => {
        if (s.type === 'enemy' && s.active) {
            let d = Math.hypot(s.x - player.x, s.y - player.y);
            if (d < 10) {
                s.x += (player.x - s.x) * 0.01;
                s.y += (player.y - s.y) * 0.01;
            }
            if (d < 0.5) player.hp -= 0.5;
        }
    });

    if (player.hp <= 0) {
        player.dead = true;
        document.getElementById('death-screen').style.display = 'flex';
    }

    document.getElementById('hp-text').innerText = Math.ceil(player.hp);
    document.getElementById('hp-fill').style.width = player.hp + "%";
}

function draw() {
    // Bakgrunnsgradient (Himmel og gulv)
    let sky = ctx.createLinearGradient(0, 0, 0, canvas.height);
    sky.addColorStop(0, "#00050a");
    sky.addColorStop(0.5, "#1a1a2e");
    ctx.fillStyle = sky;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = "#111"; // Gulv
    ctx.fillRect(0, canvas.height/2 + player.pitch, canvas.width, canvas.height);

    let camX = player.x, camY = player.y;
    if (player.is3rdPerson) {
        camX -= player.dirX * 1.5; camY -= player.dirY * 1.5;
    }

    const zBuffer = [];

    // RAYCASTING VEGGER
    for (let x = 0; x < canvas.width; x++) {
        let cameraX = 2 * x / canvas.width - 1;
        let rX = player.dirX + player.planeX * cameraX;
        let rY = player.dirY + player.planeY * cameraX;
        let mX = Math.floor(camX), mY = Math.floor(camY);
        let dX = Math.abs(1/rX), dY = Math.abs(1/rY);
        let sX, sY, sideX, sideY, hit=0, side;

        if (rX < 0) { sX = -1; sideX = (camX - mX) * dX; } else { sX = 1; sideX = (mX + 1.0 - camX) * dX; }
        if (rY < 0) { sY = -1; sideY = (camY - mY) * dY; } else { sY = 1; sideY = (mY + 1.0 - camY) * dY; }

        while(hit === 0) {
            if (sideX < sideY) { sideX += dX; mX += sX; side = 0; } else { sideY += dY; mY += sY; side = 1; }
            if (map[mX + mY * mapSize] > 0) hit = 1;
        }

        let pDist = (side === 0) ? (sideX - dX) : (sideY - dY);
        zBuffer[x] = pDist;
        let h = Math.floor(canvas.height / pDist);
        let start = -h/2 + canvas.height/2 + player.pitch;

        // Farge og skygge basert på vegg og avstand
        let wall = map[mX + mY * mapSize];
        let baseColor;
        if (wall === 3) baseColor = side === 1 ? [150, 200, 255] : [200, 230, 255]; // Speil
        else if (wall === 2) baseColor = side === 1 ? [60, 60, 70] : [80, 80, 90]; // Stål
        else baseColor = side === 1 ? [80, 40, 40] : [100, 50, 50]; // Mur

        let shadow = Math.max(0, 1 - pDist/15);
        ctx.fillStyle = `rgb(${baseColor[0]*shadow},${baseColor[1]*shadow},${baseColor[2]*shadow})`;
        ctx.fillRect(x, start, 1, h);
    }

    // SPRITES
    sprites.sort((a,b) => Math.hypot(b.x-player.x, b.y-player.y) - Math.hypot(a.x-player.x, a.y-player.y));
    sprites.forEach(s => {
        if (!s.active) return;
        let sx = s.x - camX, sy = s.y - camY;
        let inv = 1.0 / (player.planeX * player.dirY - player.dirX * player.planeY);
        let tx = inv * (player.dirY * sx - player.dirX * sy);
        let ty = inv * (-player.planeY * sx + player.planeX * sy);
        if (ty > 0.1) {
            let sX = Math.floor((canvas.width/2) * (1 + tx/ty));
            let sH = Math.abs(Math.floor(canvas.height / ty));
            if (zBuffer[sX] > ty) {
                ctx.fillStyle = s.type === 'gun' ? "#3498db" : "#e74c3c";
                ctx.fillRect(sX - sH/4, canvas.height/2 - sH/4 + player.pitch, sH/2, sH/2);
            }
        }
    });

    if (player.is3rdPerson) drawModernPlayer();
    else if (player.hasWeapon) drawModernPistol();
}

function drawModernPlayer() {
    let x = canvas.width/2, y = canvas.height/2 + 60 + player.pitch;
    ctx.fillStyle = "#ffdbac"; ctx.fillRect(x-10, y-80, 20, 20); // Hode
    ctx.fillStyle = "#2980b9"; ctx.fillRect(x-15, y-60, 30, 45); // Jakke
    ctx.fillStyle = "#2c3e50"; ctx.fillRect(x-15, y-15, 12, 35); // Ben
    ctx.fillRect(x+3, y-15, 12, 35);
}

function drawModernPistol() {
    let rec = player.recoil;
    ctx.save();
    ctx.translate(canvas.width - 200, canvas.height - 150 + player.pitch - rec);
    
    // Pistolen (Svart stål)
    ctx.fillStyle = "#1a1a1a";
    ctx.fillRect(0, 0, 50, 140); // Grep
    ctx.fillRect(-120, -10, 180, 55); // Løp
    
    // Lys-effekter
    ctx.fillStyle = "#333";
    ctx.fillRect(-120, -10, 180, 5); // Topp-kant
    
    // Muzzle Flash
    if (player.flash > 0) {
        ctx.fillStyle = "rgba(255, 200, 0, "+(player.flash/5)+")";
        ctx.beginPath();
        ctx.arc(-140, 15, 40, 0, Math.PI*2);
        ctx.fill();
    }
    ctx.restore();
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
