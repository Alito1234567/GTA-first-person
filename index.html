<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D City Survivor - FPS Edition</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; }
        canvas { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }
        
        #ui {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; pointer-events: none;
        }

        #stats {
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 5px;
            color: #ff0000; border: 2px solid #555; margin-bottom: 10px; text-align: center;
        }

        .bar-container { width: 300px; height: 15px; background: #333; border: 1px solid #fff; margin: 5px 0; }
        #hp-bar { width: 100%; height: 100%; background: #e74c3c; transition: width 0.2s; }

        #weapon-view {
            position: absolute; bottom: 0; right: 10%; width: 400px; height: auto;
            pointer-events: none; transform: translateY(20px);
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.5); font-size: 24px; pointer-events: none;
        }

        #controls-hint {
            position: absolute; top: 10px; left: 10px; color: #fff; background: rgba(0,0,0,0.5);
            padding: 10px; font-size: 12px; border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="controls-hint">
        <b>WASD</b>: Bevege & Snu<br>
        <b>SPACE</b>: Skyte<br>
        <b>M</b>: Medkit
    </div>

    <div id="crosshair">+</div>

    <div id="ui">
        <div id="stats">
            <div id="weapon-name">PISTOL</div>
            <div class="bar-container"><div id="hp-bar"></div></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/**
 * 3D FPS ENGINE (RAYCASTING)
 */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const screenWidth = window.innerWidth;
const screenHeight = window.innerHeight;
canvas.width = 400; // Lav oppløsning for retro-look og ytelse
canvas.height = 300;

// MAP: 1 = Vegg, 0 = Åpent
const mapSize = 16;
const map = [
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,
    1,0,1,1,0,1,0,1,0,1,1,1,1,1,0,1,
    1,0,1,0,0,1,0,0,0,0,0,0,0,1,0,1,
    1,0,0,0,0,1,0,1,1,1,0,1,0,1,0,1,
    1,0,1,1,1,1,0,1,0,0,0,1,0,0,0,1,
    1,0,0,0,0,0,0,1,0,1,1,1,1,1,0,1,
    1,1,1,0,1,1,1,1,0,0,0,0,0,1,0,1,
    1,0,0,0,0,0,0,0,0,1,1,1,0,0,0,1,
    1,0,1,1,1,1,1,1,0,1,0,1,0,1,1,1,
    1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,1,
    1,0,1,0,1,1,0,1,1,1,0,1,1,1,0,1,
    1,0,0,0,1,0,0,0,0,1,0,0,0,1,0,1,
    1,0,1,1,1,0,1,1,0,1,1,1,0,1,0,1,
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
];

// Spillerinstillinger
const player = {
    x: 2.5,
    y: 2.5,
    dirX: -1,
    dirY: 0,
    planeX: 0,
    planeY: 0.66,
    hp: 100,
    isShooting: 0
};

const keys = {};
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

function update() {
    const moveSpeed = 0.08;
    const rotSpeed = 0.05;

    // Bevegelse (W/S)
    if (keys['KeyW']) {
        if (map[Math.floor(player.x + player.dirX * moveSpeed) + Math.floor(player.y) * mapSize] === 0) player.x += player.dirX * moveSpeed;
        if (map[Math.floor(player.x) + Math.floor(player.y + player.dirY * moveSpeed) * mapSize] === 0) player.y += player.dirY * moveSpeed;
    }
    if (keys['KeyS']) {
        if (map[Math.floor(player.x - player.dirX * moveSpeed) + Math.floor(player.y) * mapSize] === 0) player.x -= player.dirX * moveSpeed;
        if (map[Math.floor(player.x) + Math.floor(player.y - player.dirY * moveSpeed) * mapSize] === 0) player.y -= player.dirY * moveSpeed;
    }

    // Rotasjon (A/D)
    if (keys['KeyD']) {
        let oldDirX = player.dirX;
        player.dirX = player.dirX * Math.cos(-rotSpeed) - player.dirY * Math.sin(-rotSpeed);
        player.dirY = oldDirX * Math.sin(-rotSpeed) + player.dirY * Math.cos(-rotSpeed);
        let oldPlaneX = player.planeX;
        player.planeX = player.planeX * Math.cos(-rotSpeed) - player.planeY * Math.sin(-rotSpeed);
        player.planeY = oldPlaneX * Math.sin(-rotSpeed) + player.planeY * Math.cos(-rotSpeed);
    }
    if (keys['KeyA']) {
        let oldDirX = player.dirX;
        player.dirX = player.dirX * Math.cos(rotSpeed) - player.dirY * Math.sin(rotSpeed);
        player.dirY = oldDirX * Math.sin(rotSpeed) + player.dirY * Math.cos(rotSpeed);
        let oldPlaneX = player.planeX;
        player.planeX = player.planeX * Math.cos(rotSpeed) - player.planeY * Math.sin(rotSpeed);
        player.planeY = oldPlaneX * Math.sin(rotSpeed) + player.planeY * Math.cos(rotSpeed);
    }

    // Skyte
    if (keys['Space'] && player.isShooting <= 0) {
        player.isShooting = 10;
    }
    if (player.isShooting > 0) player.isShooting--;

    // HP Bar update
    document.getElementById('hp-bar').style.width = player.hp + "%";
}

function draw() {
    // Rens skjerm (Gulv og tak)
    ctx.fillStyle = "#222"; // Tak
    ctx.fillRect(0, 0, canvas.width, canvas.height / 2);
    ctx.fillStyle = "#444"; // Gulv
    ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);

    // RAYCASTING
    for (let x = 0; x < canvas.width; x++) {
        let cameraX = 2 * x / canvas.width - 1;
        let rayDirX = player.dirX + player.planeX * cameraX;
        let rayDirY = player.dirY + player.planeY * cameraX;

        let mapX = Math.floor(player.x);
        let mapY = Math.floor(player.y);

        let sideDistX, sideDistY;

        let deltaDistX = Math.abs(1 / rayDirX);
        let deltaDistY = Math.abs(1 / rayDirY);
        let perpWallDist;

        let stepX, stepY;
        let hit = 0;
        let side;

        if (rayDirX < 0) {
            stepX = -1;
            sideDistX = (player.x - mapX) * deltaDistX;
        } else {
            stepX = 1;
            sideDistX = (mapX + 1.0 - player.x) * deltaDistX;
        }
        if (rayDirY < 0) {
            stepY = -1;
            sideDistY = (player.y - mapY) * deltaDistY;
        } else {
            stepY = 1;
            sideDistY = (mapY + 1.0 - player.y) * deltaDistY;
        }

        while (hit === 0) {
            if (sideDistX < sideDistY) {
                sideDistX += deltaDistX;
                mapX += stepX;
                side = 0;
            } else {
                sideDistY += deltaDistY;
                mapY += stepY;
                side = 1;
            }
            if (map[mapX + mapY * mapSize] > 0) hit = 1;
        }

        if (side === 0) perpWallDist = (mapX - player.x + (1 - stepX) / 2) / rayDirX;
        else perpWallDist = (mapY - player.y + (1 - stepY) / 2) / rayDirY;

        let lineHeight = Math.floor(canvas.height / perpWallDist);
        let drawStart = -lineHeight / 2 + canvas.height / 2;
        let drawEnd = lineHeight / 2 + canvas.height / 2;

        // Fargelegg vegger basert på retning (skaper realisme)
        let color = side === 1 ? '#555' : '#888';
        ctx.strokeStyle = color;
        ctx.beginPath();
        ctx.moveTo(x, drawStart);
        ctx.lineTo(x, drawEnd);
        ctx.stroke();
    }

    drawWeapon();
}

function drawWeapon() {
    const centerX = canvas.width / 2;
    const bottomY = canvas.height;
    const wobble = Math.sin(Date.now() * 0.005) * 5;
    const shootOffset = player.isShooting * 4;

    ctx.save();
    ctx.translate(centerX + 60, bottomY - 60 + wobble + shootOffset);
    
    // Tegner en enkel realistisk pistol i 3D-perspektiv
    ctx.fillStyle = "#111";
    ctx.fillRect(-20, -60, 40, 80); // Løpet
    ctx.fillStyle = "#333";
    ctx.fillRect(-15, -55, 30, 10); // Sikte
    
    if (player.isShooting > 5) {
        // Muzzle flash
        ctx.fillStyle = "orange";
        ctx.beginPath();
        ctx.arc(0, -70, 15, 0, Math.PI*2);
        ctx.fill();
    }
    ctx.restore();
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
